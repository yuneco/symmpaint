var t=Object.defineProperty,e=Object.getOwnPropertySymbols,s=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,i=(e,s,n)=>s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n,o=(t,o)=>{for(var r in o||(o={}))s.call(o,r)&&i(t,r,o[r]);if(e)for(var r of e(o))n.call(o,r)&&i(t,r,o[r]);return t},r=(t,e,s)=>(i(t,"symbol"!=typeof e?e+"":e,s),s);!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const s of t)if("childList"===s.type)for(const t of s.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();class h{constructor(t=0,e=0){r(this,"x"),r(this,"y"),this.x=t,this.y=e}equals(t){return this.x===t.x&&this.y===t.y}move(t){return new h(this.x+t.x,this.y+t.y)}sub(t){return new h(this.x-t.x,this.y-t.y)}get angle(){return Math.atan2(this.y,this.x)/Math.PI*180}get length(){return Math.sqrt(this.x**2+this.y**2)}rotate(t){const e=t/180*Math.PI,s=Math.cos(e),n=Math.sin(e),i=this.x*s-this.y*n,o=this.x*n+this.y*s;return new h(i,o)}scale(t){return new h(this.x*t,this.y*t)}}class a{constructor(t){var e,s,n;r(this,"scroll"),r(this,"scale"),r(this,"angle"),r(this,"_matrix"),this.scroll=null!=(e=null==t?void 0:t.scroll)?e:new h,this.scale=null!=(s=null==t?void 0:t.scale)?s:1,this.angle=null!=(n=null==t?void 0:t.angle)?n:0,this._matrix=(new DOMMatrix).translateSelf(this.scroll.x,this.scroll.y).scaleSelf(this.scale).rotateSelf(this.angle)}toData(){return{scroll:this.scroll,scale:this.scale,angle:this.angle}}clone(t){const e=this.toData();return new a(o(o({},e),t))}get matrix(){return this._matrix.translate()}}class l{constructor(t,e){r(this,"el"),r(this,"ctx"),r(this,"width"),r(this,"height"),r(this,"_coord");const s=document.createElement("canvas"),n=s.getContext("2d");if(!n)throw new Error("Failed to get 2d context for canvas");this.width=t,this.height=e,s.width=t,s.height=e,s.style.border="1px solid #aaa",n.lineCap="round",this.el=s,this.ctx=n,this._coord=new a}get centor(){return new h(this.width/2,this.height/2)}set coord(t){const e=this.centor;this._coord=t,this.ctx.resetTransform(),this.ctx.translate(e.x,e.y),this.ctx.scale(1/t.scale,1/t.scale),this.ctx.rotate(-t.angle/180*Math.PI),this.ctx.translate(t.scroll.x,t.scroll.y)}get coord(){return this._coord}clear(){this.ctx.save(),this.ctx.resetTransform(),this.ctx.fillStyle="#ffffff",this.ctx.fillRect(0,0,this.width,this.height),this.ctx.restore()}output(t){const e=this.centor;t.save();const s=this.coord;t.resetTransform(),t.translate(-s.scroll.x,-s.scroll.y),t.translate(e.x,e.y),t.rotate(s.angle/180*Math.PI),t.scale(s.scale,s.scale),t.translate(-e.x,-e.y),t.drawImage(this.el,0,0),t.restore()}copy(t){t.save(),t.resetTransform(),t.drawImage(this.el,0,0),t.restore()}}class c{constructor(){r(this,"listeners",[])}fire(t){this.listeners.forEach((e=>e(t)))}listen(t){this.listeners.includes(t)||this.listeners.push(t)}clear(){this.listeners.length=0}}const d=t=>new h(t.offsetWidth/2,t.offsetHeight/2),u=(t,e,s)=>{const n=e.sub(t).angle;return s.sub(t).angle-n};class v{constructor(t){r(this,"el"),r(this,"startPoint",new h),r(this,"lastPoint",new h),r(this,"isMoveWatching",!1),r(this,"onMoved",new c),r(this,"onRotated",new c),r(this,"_removeEvents"),r(this,"watchingAction"),this.el=t;const e=t=>{this.isMoveWatching=this.onDown(new h(t.offsetX,t.offsetY))},s=t=>{this.isMoveWatching&&this.onDrag(new h(t.offsetX,t.offsetY))};this.el.addEventListener("pointerdown",e),this.el.addEventListener("pointermove",s),this._removeEvents=()=>{this.el.removeEventListener("pointerdown",e),this.el.removeEventListener("pointermove",s)}}onDown(t){return("dragmove"===this.watchingAction||"dragrotate"===this.watchingAction)&&(this.startPoint=t,this.lastPoint=t,!0)}onDrag(t){if("dragmove"===this.watchingAction){const e=this.startPoint.sub(t),s=this.lastPoint.sub(t);this.lastPoint=t,this.onMoved.fire({dStart:e,dLast:s})}if("dragrotate"===this.watchingAction){const e=u(d(this.el),this.startPoint,t),s=e-u(d(this.el),this.lastPoint,t);this.lastPoint=t,this.onRotated.fire({dStart:e,dLast:s})}}listenMove(...t){this.onMoved.listen(...t)}listenRotate(...t){this.onRotated.listen(...t)}destroy(){this._removeEvents(),this.onMoved.clear(),this.onRotated.clear()}}class p{constructor(t){r(this,"target"),r(this,"_keys",{}),r(this,"_removeEvents"),r(this,"onChange",new c),this.target=null!=t?t:document.body;const e=t=>{const e=t.key;this._keys[e]=!0,this.onChange.fire({key:e,isDown:!0})},s=t=>{const e=t.key;delete this._keys[e],this.onChange.fire({key:e,isDown:!1})};this.target.addEventListener("keydown",e),this.target.addEventListener("keyup",s),this._removeEvents=()=>{this.target.removeEventListener("keydown",e),this.target.removeEventListener("keyup",s)}}listen(...t){this.onChange.listen(...t)}destroy(){this._removeEvents(),this.onChange.clear()}key(t){return!!this._keys[t]}get keys(){return Object.keys(this._keys)}}const g=t=>{t.ctx.save(),t.ctx.resetTransform(),t.ctx.clearRect(0,0,t.width,t.height),t.ctx.restore()},w=t=>{const e=t.includes(" "),s=t.includes("Alt"),n=t.includes("Meta"),i=t.includes("Shift");return e&&n&&s?"zoomdown":e&&n?"zoomup":e&&s?"rotate":e?"scroll":i?"draw:line":s?"draw:stamp":"draw"};class m{constructor(t=10){r(this,"maxItems"),r(this,"items",[]),r(this,"onOverflow",new c),this.maxItems=t}get length(){return this.items.length}clear(){this.items.length=0}push(t){if(this.items.push(t),this.items.length<=this.maxItems)return;const e=this.items.shift();e&&this.onOverflow.fire(e)}pop(){return this.items.pop()}peek(t=0){return this.items[this.items.length-1+t]}getItems(){return[...this.items]}listenOverflow(...t){this.onOverflow.listen(...t)}}class f{constructor(){r(this,"position",new h),r(this,"_coord"),r(this,"children",[]),this._coord=new a}get coord(){return this._coord}set coord(t){this._coord=this._coord.clone({scale:t.scale,scroll:t.scroll,angle:t.angle})}get childCount(){return this.children.length}get pos(){return this.position}get state(){return{position:this.position,coord:this.coord,children:this.children.map((t=>t.state))}}set state(t){for(this.position=t.position,this.coord=t.coord,this.children.length>t.children.length&&(this.children.length=t.children.length);this.children.length<t.children.length;)this.addChildPen();t.children.forEach(((t,e)=>{this.children[e].state=t}))}get leafs(){return this.childCount?this.children.flatMap((t=>t.leafs)):[this]}addChildPen(t){const e=new f;return t&&(e.coord=t),this.children.push(e),e}clearChildren(){this.children.length=0}moveTo(t){this.position=t,this.children.forEach((e=>e.moveTo(t)))}drawTo(t,e,s,n=.5,i=""){const o=t.ctx;i&&console.group(i);const r=e.multiply(this.coord.matrix);if(0===this.childCount){const t=r.transformPoint(this.position),e=r.transformPoint(s),h=o.lineWidth;o.beginPath(),o.lineWidth=h*n,o.moveTo(t.x,t.y),o.lineTo(e.x,e.y),i&&console.log(`${t.x} ${t.y}, ${e.x} ${e.y}`),o.stroke(),o.lineWidth=h}this.children.forEach(((e,o)=>e.drawTo(t,r,s,n,i?`${i}-${o}`:""))),this.position=s,i&&console.groupEnd()}drawLines(t,e,s,n=.5){if(s.length<2)return;const i=t.ctx,o=e.multiply(this.coord.matrix);if(0===this.childCount){const[t,...e]=s,r=i.lineWidth;i.lineWidth=r*n,i.beginPath();const h=o.transformPoint(t);i.moveTo(h.x,h.y),e.forEach((t=>{const e=o.transformPoint(t);i.lineTo(e.x,e.y)})),i.stroke(),i.lineWidth=r}this.children.forEach((e=>e.drawLines(t,o,s,n)))}drayRun(t,e){const s=t.multiply(this.coord.matrix);return 0===this.childCount?[e.map((t=>{const e=s.transformPoint(t.point);return{point:new h(e.x,e.y),pressure:t.pressure}}))]:this.children.flatMap((t=>t.drayRun(s,e)))}}const y=t=>{const e=t.findIndex(((t,e)=>e>0&&0===t.pressure));if(-1===e)return[t];const s=t.slice(0,e),n=t.slice(e);return[...!(1===s.length&&0===s[0].pressure)?[s]:[],...!(1===n.length&&0===n[0].pressure)?y(n):[]]},S=(t,e,s)=>{const n=new DOMMatrix;t.coord=e.canvasCoord,t.ctx.lineWidth=e.style.penSize*e.canvasCoord.scale;const i=new f;if(i.state=e.penState,s){y(e.inputs).forEach((e=>{const s=(o=e).length?(r=o.map((t=>t.pressure))).reduce(((t,e)=>t+e),0)/r.length:0;var o,r;i.drawLines(t,n,e.map((t=>t.point)),s)}))}else{const[s,...o]=e.inputs;if(!s)return;i.moveTo(s.point),o.forEach((e=>{e.pressure?i.drawTo(t,n,e.point,e.pressure):i.moveTo(e.point)}))}},C=(t,e,s=!1)=>{e.forEach((e=>{"pen"===e.tool&&S(t,e,s),"clearAll"===e.tool&&(t=>{t.clear()})(t)}))};class x{constructor(t,e,s,n="pen"){r(this,"inputs",[]),r(this,"penState"),r(this,"style"),r(this,"canvasCoord"),r(this,"tool"),this.canvasCoord=t,this.penState=e,this.style=s,this.tool=n}addPoint(t,e){this.inputs.push({point:t,pressure:e})}clearPoints(t=!1,e=!1){const s=t?this.inputs.shift():void 0,n=e?this.inputs.pop():void 0;this.inputs.length=0,s&&this.inputs.push(s),n&&this.inputs.push(n)}get flatten(){const t=new f;t.state=this.penState;const e=(t=>t.flatMap((t=>{if(!t.length)return t;const e=t[0],s=t[t.length-1];return[{point:e.point,pressure:0},...t,{point:s.point,pressure:0}]})))(t.drayRun(new DOMMatrix,this.inputs));t.clearChildren();const s=new x(this.canvasCoord,t.state,this.style,this.tool);return s.inputs.push(...e),s}}class k{constructor(t,e){r(this,"canvasWidth"),r(this,"canvasHeight"),r(this,"history",new m(1/0)),r(this,"snapshots",new m(11)),r(this,"currentStroke"),r(this,"lastSnapshotIndex",0),r(this,"oldestSnapshotIndex",0),r(this,"oldestSnapshot"),this.canvasWidth=t,this.canvasHeight=e,this.addSnapshot(),this.snapshots.listenOverflow((t=>{this.oldestSnapshotIndex+=10,this.oldestSnapshot=t,console.log(`oldestSnapshotIndex: ${this.oldestSnapshotIndex}`)}))}get strokes(){return this.history.peek()}get snapshot(){return this.snapshots.peek()}get prevSnapshot(){return this.snapshots.peek(-1)}get lastHistories(){return this.history.getItems().slice(this.lastSnapshotIndex+1)}addSnapshot(){const t=new l(this.canvasWidth,this.canvasHeight);this.snapshots.push(t);const e=this.prevSnapshot;e&&t.ctx.drawImage(e.el,0,0),this.lastSnapshotIndex=this.history.length-1}start(t,e,s,n){const i=new x(t,e,s,n);return this.currentStroke=i,i}commit(){if(!this.currentStroke)return;this.history.push(this.currentStroke),C(this.snapshot,[this.currentStroke]);10===this.history.length-this.lastSnapshotIndex-1&&(console.log("new snapshot",this.snapshots.length),this.addSnapshot()),this.currentStroke=void 0}rollback(){this.currentStroke&&(console.log("stroke rollbacked"),this.currentStroke=void 0)}get current(){return this.currentStroke}get undoable(){return this.history.length>this.oldestSnapshotIndex}undo(t){var e;if(!this.undoable)return console.log("no more history"),!1;const s=null!=(e=this.prevSnapshot)?e:this.oldestSnapshot;return s?t.ctx.drawImage(s.el,0,0):console.log("no prev"),this.history.pop(),C(t,this.lastHistories),!this.lastHistories.length&&this.snapshots.length>1&&(this.snapshots.pop(),console.log("back prev snap",this.snapshots.length),this.lastSnapshotIndex-=10),!0}}class P{constructor(t="#00000",e=10){r(this,"color"),r(this,"penSize"),this.color=t,this.penSize=e}}class E{constructor(t){r(this,"el");const e=this.el=document.createElement("button");e.className="Button",e.textContent=t}addEventListener(...t){return this.el.addEventListener(...t)}removeEventListener(...t){return this.el.removeEventListener(...t)}}class W{constructor(t,e=0,s=100,n=0,i=!1){r(this,"el"),r(this,"elSlider"),r(this,"elText"),r(this,"isPercent");const o=this.el=document.createElement("div"),h=this.elSlider=document.createElement("input"),a=document.createElement("label"),l=document.createElement("span"),c=this.elText=document.createElement("span");this.isPercent=i,o.appendChild(a),a.appendChild(l),a.appendChild(c),a.appendChild(h),h.type="range",h.className="Slider",h.min=String(e),h.max=String(s),h.value=String(n),l.textContent=`${t}: `,c.textContent=h.value,h.addEventListener("input",(()=>{c.textContent=h.value}))}get value(){return this.elSlider.valueAsNumber*(this.isPercent?.01:1)}set value(t){const e=t*(this.isPercent?100:1);this.elSlider.value=String(e),this.elText.textContent=String(e)}addEventListener(...t){return this.elSlider.addEventListener(...t)}removeEventListener(...t){return this.elSlider.removeEventListener(...t)}}const M=[0,.2,.33,.5,.67,.75,1,1.5,2,2.5,3,3.5,4,1/0],b=document.querySelector("#main"),L=document.querySelector("#palette"),T=new class{constructor(t){r(this,"slScale"),r(this,"slAngle"),r(this,"slX"),r(this,"slY"),r(this,"slPenCount"),r(this,"slPenWidth"),r(this,"onScaleChange",new c),r(this,"onAngleChange",new c),r(this,"onScrollChange",new c),r(this,"onPenCountChange",new c),r(this,"onPenWidthChange",new c),r(this,"onClear",new c),r(this,"onUndo",new c);const e=this.slScale=new W("Scale",50,300,100,!0),s=this.slAngle=new W("Angle",-360,360,0),n=this.slX=new W("Scroll X",-400,400,0),i=this.slY=new W("Scroll Y",-400,400,0),o=this.slPenCount=new W("Pen Count",1,12,1),a=this.slPenWidth=new W("Pen Size",1,40,10),l=new E("Clear All"),d=new E("Undo");t.appendChild(o.el),t.appendChild(a.el),t.appendChild(l.el),t.appendChild(d.el),e.addEventListener("input",(()=>{this.onScaleChange.fire(e.value)})),s.addEventListener("input",(()=>{this.onAngleChange.fire(s.value)})),n.addEventListener("input",(()=>{this.onScrollChange.fire(new h(n.value,i.value))})),i.addEventListener("input",(()=>{this.onScrollChange.fire(new h(n.value,i.value))})),o.addEventListener("input",(()=>{this.onPenCountChange.fire(o.value)})),a.addEventListener("input",(()=>{this.onPenWidthChange.fire(a.value)})),l.addEventListener("click",(()=>{this.onClear.fire()})),d.addEventListener("click",(()=>{this.onUndo.fire()}))}get scale(){return this.slScale.value}get angle(){return this.slAngle.value}get scroll(){return new h(this.slX.value,this.slY.value)}get penCount(){return this.slPenCount.value}get penWidth(){return this.slPenWidth.value}set scale(t){this.scale!==t&&(this.slScale.value=t,this.onScaleChange.fire(this.slScale.value))}set angle(t){this.angle!==t&&(this.slAngle.value=t,this.onAngleChange.fire(this.slAngle.value))}set scrollX(t){this.slX.value!==t&&(this.slX.value=t,this.onScrollChange.fire(new h(this.slX.value,this.slY.value)))}set scrollY(t){this.slY.value!==t&&(this.slY.value=t,this.onScrollChange.fire(new h(this.slX.value,this.slY.value)))}set penCount(t){this.penCount!==t&&(this.slPenCount.value=t,this.onPenCountChange.fire(this.slPenCount.value))}set penWidth(t){this.penWidth!==t&&(this.slPenWidth.value=t,this.onPenWidthChange.fire(this.slPenWidth.value))}}(L),I=new class{constructor(t){var e,s;r(this,"canvas"),r(this,"strokeCanvas"),r(this,"view"),r(this,"keyWatcher"),r(this,"dragWatcher"),r(this,"eventStatus",{isWatchMove:!1,isUseStrokeCanvas:!1,activeEvent:void 0,startCoord:new a,startPoint:new h,isCapturing:!1}),r(this,"history"),r(this,"requestChangeZoom",new c),r(this,"requestScrollTo",new c),r(this,"requestRotateTo",new c),r(this,"pen"),r(this,"style",new P),r(this,"stamp"),this.canvas=new l(800,800),this.strokeCanvas=new l(800,800),this.view=new l(800,800),this.history=new k(800,800),t.appendChild(this.view.el);const n=document.getElementById("debug");n&&(this.canvas.el.style.width="200px",this.canvas.el.style.height="200px",this.strokeCanvas.el.style.width="200px",this.strokeCanvas.el.style.height="200px",null==(e=n.querySelector(".canvas"))||e.appendChild(this.canvas.el),null==(s=n.querySelector(".stroke"))||s.appendChild(this.strokeCanvas.el)),this.registerEventHandlers(),this.keyWatcher=new p,this.keyWatcher.listen((()=>{this.view.el.style.cursor=(t=>{var e;return null!=(e={draw:"crosshair",scroll:"move",zoomup:"zoom-in",zoomdown:"zoom-out",rotate:"grab","draw:line":"crosshair","draw:stamp":"crosshair"}[t])?e:"default"})(w(this.keyWatcher.keys))})),this.dragWatcher=new v(this.view.el),this.dragWatcher.listenMove((({dStart:t})=>{const e=this.eventStatus.startCoord.scroll.move(t);this.requestScrollTo.fire(e)})),this.dragWatcher.listenRotate((({dStart:t})=>{const e=(t=>{const e=t>=0?t%360:360+t%360;return e<=180?e:-360+e})(this.eventStatus.startCoord.angle+t);this.requestRotateTo.fire(e)})),this.pen=new f,this.clear(!1)}registerEventHandlers(){const t=this.view.el;let e=new h;t.addEventListener("pointerdown",(t=>{e=new h(t.screenX,t.screenY),this.onDown(t)})),t.addEventListener("pointermove",(t=>{if(!this.eventStatus.isWatchMove)return;const s=new h(t.screenX,t.screenY);s.sub(e).length<3||(this.onMove(t),e=s)})),t.addEventListener("pointerup",(t=>this.eventStatus.isWatchMove&&this.onUp(t)))}get coord(){return this.canvas.coord}set coord(t){this.canvas.coord=t.clone({}),this.rePaint()}get penCount(){return this.pen.childCount}set penCount(t){if(t===this.penCount)return;const e=this.pen;e.clearChildren();for(let s=0;s<t;s++)e.addChildPen(new a({angle:360*s/t}));this.rePaint()}set penWidth(t){this.style=new P(this.style.color,t)}listenRequestZoom(...t){this.requestChangeZoom.listen(...t)}listenRequestScrollTo(...t){this.requestScrollTo.listen(...t)}listenRequestRotateTo(...t){this.requestRotateTo.listen(...t)}clear(t=!0){var e;t&&(this.history.start(this.coord,this.pen.state,this.style,"clearAll"),this.history.commit()),this.canvas.clear(),(e=this.canvas).ctx.save(),e.ctx.resetTransform(),e.ctx.strokeStyle="#aaaaaa",e.ctx.strokeRect(0,0,e.width,e.height),e.ctx.restore(),this.rePaint()}undo(){this.history.undoable&&(this.clear(!1),this.history.undo(this.canvas),this.rePaint())}event2canvasPoint(t){return new h(1*t.offsetX-400,1*t.offsetY-400)}onDown(t){const e=w(this.keyWatcher.keys);this.eventStatus.activeEvent=e,this.eventStatus.startCoord=this.coord,this.eventStatus.startPoint=this.event2canvasPoint(t),this.eventStatus.isCapturing=t.metaKey,"draw"!==e&&"draw:line"!==e&&"draw:stamp"!==e||(this.eventStatus.isWatchMove=!0,this.startStroke(this.eventStatus.startPoint)),"zoomup"===e&&this.requestChangeZoom.fire(!0),"zoomdown"===e&&this.requestChangeZoom.fire(!1),"scroll"===e&&(this.eventStatus.isWatchMove=!0,this.dragWatcher.watchingAction="dragmove"),"rotate"===e&&(this.eventStatus.isWatchMove=!0,this.dragWatcher.watchingAction="dragrotate")}onMove(t){const e=this.eventStatus.activeEvent;if("draw"===e&&this.continueStroke(this.event2canvasPoint(t),t.pressure||.5),"draw:line"===e&&(g(this.strokeCanvas),this.pen.moveTo(this.eventStatus.startPoint),this.continueStroke(this.event2canvasPoint(t),t.pressure||.5)),"draw:stamp"===e&&this.stamp){g(this.strokeCanvas);const e=this.event2canvasPoint(t).sub(this.eventStatus.startPoint),s=e.length/100;this.putStroke(this.stamp,this.eventStatus.startPoint,s,e.angle,!0)}t.preventDefault()}onUp(t){var e,s;const n=this.eventStatus.activeEvent,i="draw"===n||"draw:line"===n||"draw:stamp"===n;var o;if("draw"===n&&this.continueStroke(this.event2canvasPoint(t),t.pressure||0),"draw:line"===n&&(g(this.strokeCanvas),this.pen.moveTo(this.eventStatus.startPoint),this.continueStroke(this.event2canvasPoint(t),this.history.current?(o=this.history.current.inputs).length?o[Math.floor(.9*o.length)].pressure:0:.5),null==(e=this.history.current)||e.clearPoints(!0,!0)),"draw:stamp"===n&&this.stamp){g(this.strokeCanvas);const e=this.event2canvasPoint(t).sub(this.eventStatus.startPoint),s=e.length/100;this.putStroke(this.stamp,this.eventStatus.startPoint,s,e.angle,!1)}if(("draw"===n||"draw:line"===n)&&this.eventStatus.isCapturing)return this.stamp=null==(s=this.history.current)?void 0:s.flatten,this.endStroke(!1),void this.rePaint();this.endStroke(i)}startStroke(t){var e;this.eventStatus.isUseStrokeCanvas=!0,this.strokeCanvas.coord=this.canvas.coord,this.strokeCanvas.ctx.lineWidth=this.style.penSize*this.canvas.coord.scale,this.history.start(this.coord,this.pen.state,this.style),null==(e=this.history.current)||e.addPoint(t,.5),this.pen.moveTo(t)}continueStroke(t,e=.5){var s;null==(s=this.history.current)||s.addPoint(t,e),this.pen.drawTo(this.strokeCanvas,new DOMMatrix,t,e),this.rePaint()}endStroke(t){t?(this.history.commit(),this.strokeCanvas.copy(this.canvas.ctx),g(this.strokeCanvas)):(this.history.rollback(),g(this.strokeCanvas)),this.eventStatus.isWatchMove=!1,this.eventStatus.isUseStrokeCanvas=!1,this.eventStatus.activeEvent=void 0,this.dragWatcher.watchingAction=void 0}putStroke(t,e,s,n,i){const o=new f;o.state=this.pen.state;const r=new f;r.state=t.penState,r.coord=r.coord.clone({scroll:e,scale:s,angle:n}),o.leafs.forEach((t=>t.addChildPen())),o.leafs.forEach((t=>t.state=r.state));const h=new x(this.coord,o.state,this.style,t.tool);h.inputs.push(...t.inputs),S(this.strokeCanvas,h,i),this.rePaint();const a=this.history.current;if(!i&&a){this.history.rollback();this.history.start(a.canvasCoord,o.state,this.style,a.tool).inputs.push(...t.inputs)}}rePaint(){var t,e;t=this.view,e="#cccccc",t.ctx.save(),t.ctx.resetTransform(),t.ctx.fillStyle=e,t.ctx.fillRect(0,0,t.width,t.height),t.ctx.restore(),this.canvas.output(this.view.ctx),this.eventStatus.isUseStrokeCanvas&&this.strokeCanvas.output(this.view.ctx),this.penCount>=2&&((t,e)=>{const s=new h(t.width/2,t.height/2);t.ctx.save(),t.ctx.resetTransform(),t.ctx.translate(s.x,s.y),t.ctx.lineWidth=1,t.ctx.strokeStyle="#aaccccbb";for(let n=0;n<e;n++)t.ctx.beginPath(),t.ctx.moveTo(0,0),t.ctx.lineTo(0,t.height),t.ctx.stroke(),t.ctx.closePath(),t.ctx.rotate(360/e/180*Math.PI);t.ctx.restore()})(this.view,this.penCount)}}(b);T.onScaleChange.listen((t=>{I.coord=I.coord.clone({scale:t})})),T.onAngleChange.listen((t=>{I.coord=I.coord.clone({angle:t})})),T.onScrollChange.listen((t=>{I.coord=I.coord.clone({scroll:t})})),T.onPenCountChange.listen((t=>{I.penCount=t})),T.onPenWidthChange.listen((t=>{I.penWidth=t})),T.onClear.listen((()=>{I.clear()})),T.onUndo.listen((()=>{I.undo()})),I.coord=I.coord.clone({scroll:T.scroll,scale:T.scale,angle:T.angle}),I.listenRequestZoom((t=>{T.scale=((t,e)=>{var s;const n=e?M:[...M].reverse(),i=n.findIndex((s=>e?s>t:s<t)),o=null!=(s=n[i])?s:0;return Math.max(.2,Math.min(4,o))})(T.scale,t)})),I.listenRequestScrollTo((t=>{T.scrollX=t.x,T.scrollY=t.y})),I.listenRequestRotateTo((t=>{T.angle=t})),window.addEventListener("keydown",(t=>{"ArrowUp"===t.key&&T.penCount++,"ArrowDown"===t.key&&T.penCount--,"z"===t.key&&t.metaKey&&T.onUndo.fire()})),T.penCount=5,b.addEventListener("touchmove",(function(t){t.preventDefault()}));const A="ja"===navigator.language?"ja":"en";document.querySelectorAll(".lang").forEach((t=>t.style.display="none")),document.querySelectorAll(`.lang.${A}`).forEach((t=>t.style.display=""));
