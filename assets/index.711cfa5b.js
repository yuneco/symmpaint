var tt=Object.defineProperty;var Y=Object.getOwnPropertySymbols;var et=Object.prototype.hasOwnProperty,st=Object.prototype.propertyIsEnumerable;var R=(s,t,e)=>t in s?tt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,L=(s,t)=>{for(var e in t||(t={}))et.call(t,e)&&R(s,e,t[e]);if(Y)for(var e of Y(t))st.call(t,e)&&R(s,e,t[e]);return s};var r=(s,t,e)=>(R(s,typeof t!="symbol"?t+"":t,e),e);const nt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function e(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerpolicy&&(o.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?o.credentials="include":i.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=e(i);fetch(i.href,o)}};nt();class u{constructor(t=0,e=0){r(this,"x");r(this,"y");this.x=t,this.y=e}equals(t){return this.x===t.x&&this.y===t.y}move(t){return new u(this.x+t.x,this.y+t.y)}sub(t){return new u(this.x-t.x,this.y-t.y)}get angle(){return Math.atan2(this.y,this.x)/Math.PI*180}get length(){return Math.sqrt(this.x**2+this.y**2)}rotate(t){const e=t/180*Math.PI,n=Math.cos(e),i=Math.sin(e),o=this.x*n-this.y*i,l=this.x*i+this.y*n;return new u(o,l)}scale(t){return new u(this.x*t,this.y*t)}}class P{constructor(t){r(this,"scroll");r(this,"scale");r(this,"angle");r(this,"flipY");r(this,"_matrix");var e,n,i,o;this.scroll=(e=t==null?void 0:t.scroll)!=null?e:new u,this.scale=(n=t==null?void 0:t.scale)!=null?n:1,this.angle=(i=t==null?void 0:t.angle)!=null?i:0,this.flipY=(o=t==null?void 0:t.flipY)!=null?o:!1,this._matrix=new DOMMatrix().translateSelf(this.scroll.x,this.scroll.y).scaleSelf(this.scale,this.scale*(this.flipY?-1:1)).rotateSelf(this.angle)}toData(){return{scroll:this.scroll,scale:this.scale,angle:this.angle,flipY:this.flipY}}clone(t){const e=this.toData();return new P(L(L({},e),t))}get matrix(){return this._matrix.translate(0)}}class A{constructor(t,e){r(this,"el");r(this,"ctx");r(this,"width");r(this,"height");r(this,"_coord");const n=document.createElement("canvas"),i=n.getContext("2d");if(!i)throw new Error("Failed to get 2d context for canvas");this.width=t,this.height=e,n.width=t,n.height=e,i.lineCap="round",this.el=n,this.ctx=i,this._coord=new P}get centor(){return new u(this.width/2,this.height/2)}set coord(t){const e=this.centor;this._coord=t,this.ctx.resetTransform(),this.ctx.translate(e.x,e.y),this.ctx.translate(t.scroll.x,t.scroll.y),this.ctx.rotate(-t.angle/180*Math.PI),this.ctx.scale(1/t.scale,1/t.scale)}get coord(){return this._coord}output(t,e){const n=this.centor;t.save();const i=this.coord;t.resetTransform(),t.translate(n.x,n.y),t.scale(i.scale,i.scale),t.rotate(i.angle/180*Math.PI),t.translate(-i.scroll.x,-i.scroll.y),t.translate(-n.x,-n.y),this.transferImageTo(t,e),t.restore()}copy(t,e){t.save(),t.resetTransform(),this.transferImageTo(t,e),t.restore()}transferImageTo(t,e){var n;t.globalAlpha=(n=e==null?void 0:e.alpha)!=null?n:1,(e==null?void 0:e.background)&&(t.fillStyle=e.background,t.fillRect(0,0,this.width,this.height)),t.drawImage(this.el,0,0)}}class f{constructor(){r(this,"listeners",[])}fire(t){this.listeners.forEach(e=>e(t))}listen(t){this.listeners.includes(t)||this.listeners.push(t)}clear(){this.listeners.length=0}}const z=s=>{const t=s>=0?s%360:360+s%360;return t<=180?t:-360+t},it=s=>s/180*Math.PI,ot=(s,t)=>{const n=s.matrix.multiply(t.matrix).transformPoint();return new P({scroll:new u(n.x,n.y),angle:s.angle+t.angle,scale:s.scale*t.scale})},k=s=>{s.ctx.save(),s.ctx.resetTransform(),s.ctx.clearRect(0,0,s.width,s.height),s.ctx.restore()},rt=(s,t)=>{s.ctx.save(),s.ctx.resetTransform(),s.ctx.fillStyle=t,s.ctx.fillRect(0,0,s.width,s.height),s.ctx.restore()},lt=(s,t,e)=>{const n="#91bcccbb",i=e?"#c5e4ebbb":n,o=new u(s.width/2,s.height/2);s.ctx.save(),s.ctx.resetTransform(),s.ctx.translate(o.x,o.y),s.ctx.lineWidth=1,s.ctx.rotate(it(-90+360/t/2));for(let l=0;l<t;l++)s.ctx.strokeStyle=l%2==0?n:i,s.ctx.beginPath(),s.ctx.moveTo(0,0),s.ctx.lineTo(0,s.height),s.ctx.stroke(),s.ctx.closePath(),s.ctx.rotate(360/t/180*Math.PI);s.ctx.restore()};class B{constructor(t=10){r(this,"maxItems");r(this,"items",[]);r(this,"onOverflow",new f);this.maxItems=t}get length(){return this.items.length}clear(){this.items.length=0}push(t){if(this.items.push(t),this.items.length<=this.maxItems)return;const e=this.items.shift();e&&this.onOverflow.fire(e)}pop(){return this.items.pop()}peek(t=0){return this.items[this.items.length-1+t]}getItems(){return[...this.items]}listenOverflow(...t){this.onOverflow.listen(...t)}}class E{constructor(){r(this,"position",new u);r(this,"_coord");r(this,"children",[]);this._coord=new P}get coord(){return this._coord}set coord(t){this._coord=this._coord.clone({scale:t.scale,scroll:t.scroll,angle:t.angle,flipY:t.flipY})}get childCount(){return this.children.length}get pos(){return this.position}get state(){return{position:this.position,coord:this.coord,children:this.children.map(t=>t.state)}}set state(t){for(this.position=t.position,this.coord=t.coord,this.children.length>t.children.length&&(this.children.length=t.children.length);this.children.length<t.children.length;)this.addChildPen();t.children.forEach((e,n)=>{this.children[n].state=e})}get leafs(){return this.childCount?this.children.flatMap(t=>t.leafs):[this]}addChildPen(t){const e=new E;return t&&(e.coord=t),this.children.push(e),e}clearChildren(){this.children.length=0}moveTo(t){this.position=t,this.children.forEach(e=>e.moveTo(t))}drawTo(t,e,n,i=.5,o=""){if(i<=0)return;const l=t.ctx;o&&console.group(o);const a=e.multiply(this.coord.matrix);if(this.childCount===0){const h=a.transformPoint(this.position),g=a.transformPoint(n),c=l.lineWidth;l.beginPath(),l.lineWidth=c*i,l.moveTo(h.x,h.y),l.lineTo(g.x,g.y),o&&console.log(`${h.x} ${h.y}, ${g.x} ${g.y}`),l.stroke(),l.lineWidth=c}this.children.forEach((h,g)=>h.drawTo(t,a,n,i,o?`${o}-${g}`:"")),this.position=n,o&&console.groupEnd()}drawLines(t,e,n,i=.5){if(n.length<2)return;const o=t.ctx,l=e.multiply(this.coord.matrix);if(this.childCount===0){const[a,...h]=n,g=o.lineWidth;o.lineWidth=g*i,o.beginPath();const c=l.transformPoint(a);o.moveTo(c.x,c.y),h.forEach(C=>{const m=l.transformPoint(C);o.lineTo(m.x,m.y)}),o.stroke(),o.lineWidth=g}this.children.forEach(a=>a.drawLines(t,l,n,i))}drayRun(t,e){const n=t.multiply(this.coord.matrix);return this.childCount===0?[e.map(i=>{const o=n.transformPoint(i.point);return{point:new u(o.x,o.y),pressure:i.pressure}})]:this.children.flatMap(i=>i.drayRun(n,e))}}const at=s=>s.reduce((t,e)=>t+e,0)/s.length,ht=s=>{if(!s.length)return 0;const t=Math.floor(s.length*.9);return s[t].pressure},ct=s=>s.length?at(s.map(t=>t.pressure).filter(t=>t>0)):0,U=s=>{const t=s.findIndex((l,a)=>a>0&&l.pressure===0);if(t===-1)return[s];const e=s.slice(0,t),n=s.slice(t),i=!(e.length===1&&e[0].pressure===0),o=!(n.length===1&&n[0].pressure===0);return[...i?[e]:[],...o?U(n):[]]},X=(s,t,e)=>{const n=new DOMMatrix;s.coord=t.canvasCoord,s.ctx.strokeStyle=t.style.color,s.ctx.lineWidth=t.style.penSize*t.canvasCoord.scale;const i=new E;if(i.state=t.penState,e)U(t.inputs).forEach(l=>{const a=ct(l);i.drawLines(s,n,l.map(h=>h.point),a)});else{const[o,...l]=t.inputs;if(!o)return;i.moveTo(o.point),l.forEach(a=>{a.pressure?i.drawTo(s,n,a.point,a.pressure):i.moveTo(a.point)})}},ut=s=>{k(s)},dt=(s,t,e,n=!1)=>{e.forEach(i=>{i.tool==="pen"&&(k(t),X(t,i,n),t.copy(s.ctx,{alpha:i.style.alpha})),i.tool==="clearAll"&&ut(s)}),k(t)},pt=s=>s.flatMap(t=>{if(!t.length)return t;const e=t[0],n=t[t.length-1];return[{point:e.point,pressure:0},...t,{point:n.point,pressure:0}]});class I{constructor(t,e,n,i="pen"){r(this,"inputs",[]);r(this,"penState");r(this,"style");r(this,"canvasCoord");r(this,"tool");this.canvasCoord=t,this.penState=e,this.style=n,this.tool=i}addPoint(t,e){this.inputs.push({point:t,pressure:e})}clearPoints(t=!1,e=!1){const n=t?this.inputs.shift():void 0,i=e?this.inputs.pop():void 0;this.inputs.length=0,n&&this.inputs.push(n),i&&this.inputs.push(i)}get flatten(){const t=new E;t.state=this.penState;const e=t.drayRun(new DOMMatrix,this.inputs),n=pt(e);t.clearChildren();const i=new I(this.canvasCoord,t.state,this.style,this.tool);return i.inputs.push(...n),i}}const gt=110,D=10;class ft{constructor(t,e){r(this,"canvasWidth");r(this,"canvasHeight");r(this,"history",new B(1/0));r(this,"snapshots",new B(gt/D));r(this,"currentStroke");r(this,"lastSnapshotIndex",0);r(this,"oldestSnapshotIndex",0);this.canvasWidth=t,this.canvasHeight=e,this.snapshots.listenOverflow(()=>{this.oldestSnapshotIndex+=D,console.log(`oldestSnapshotIndex: ${this.oldestSnapshotIndex}`)})}get strokes(){return this.history.peek()}get snapshot(){return this.snapshots.peek()}get prevSnapshot(){return this.snapshots.peek(-1)}get lastHistories(){return this.history.getItems().slice(this.lastSnapshotIndex)}addSnapshot(){const t=new A(this.canvasWidth,this.canvasHeight);this.snapshots.push(t);const e=this.prevSnapshot;e&&t.ctx.drawImage(e.el,0,0);const n=document.querySelector("#debug .history .snaps");if(n){const i=120/Math.max(t.el.width,t.el.height);t.el.style.width=t.el.width*i+"px",t.el.style.height=t.el.height*i+"px",n.appendChild(t.el),t.el.scrollIntoView()}this.lastSnapshotIndex=this.history.length-1}start(t,e,n,i){const o=new I(t,e,n,i);return this.currentStroke=o,o}commit(t){if(!this.currentStroke)return;this.history.push(this.currentStroke),this.history.length-this.lastSnapshotIndex-1===D&&(this.addSnapshot(),t.copy(this.snapshot.ctx,{alpha:this.currentStroke.style.alpha}),console.log("new snapshot",this.snapshots.length)),this.currentStroke=void 0}rollback(){!this.currentStroke||(console.log("stroke rollbacked"),this.currentStroke=void 0)}get current(){return this.currentStroke}get undoable(){return this.history.length>this.oldestSnapshotIndex}undo(t,e){var i;if(!this.undoable)return console.log("no more history"),!1;t.ctx.save();const n=this.snapshot;if(n?(t.ctx.resetTransform(),t.ctx.drawImage(n.el,0,0)):console.log("no prev"),this.history.pop(),dt(t,e,this.lastHistories),!this.lastHistories.length&&this.snapshots.length>=1){const o=this.snapshots.pop();o&&((i=document.getElementById("debug"))==null||i.removeChild(o.el)),this.lastSnapshotIndex-=D,console.log("back prev snap",this.snapshots.length,this.snapshots)}return t.ctx.restore(),!0}}class K{constructor(t){r(this,"color");r(this,"penSize");r(this,"alpha");var e,n,i;this.color=(e=t==null?void 0:t.color)!=null?e:"#000000",this.penSize=(n=t==null?void 0:t.penSize)!=null?n:10,this.alpha=(i=t==null?void 0:t.alpha)!=null?i:1}toData(){return{color:this.color,penSize:this.penSize,alpha:this.alpha}}clone(t){return new K(L(L({},this.toData()),t))}}const vt=s=>{var t;return(t={draw:"crosshair",scroll:"move",zoomup:"zoom-in",zoomdown:"zoom-out",rotate:"grab","draw:line":"crosshair","draw:stamp":"crosshair"}[s])!=null?t:"default"},Ct=s=>{const t=s.getBoundingClientRect();return new u(t.left+t.width/2,t.top+t.height/2)},mt=(s,t,e)=>{const n=t.sub(s).angle;return e.sub(s).angle-n},H=(s,t,e)=>({distance:e.sub(t),angle:mt(Ct(s),t,e)}),wt=(s,t,e,n,i=1)=>{const o={startPoint:new u,lastRawPoint:new u,isWatchMove:!1},l=c=>{!c.isPrimary||(o.startPoint=o.lastRawPoint=new u(c.clientX,c.clientY),o.isWatchMove=t(c))},a=c=>{if(!c.isPrimary||!o.isWatchMove)return;const C=new u(c.clientX,c.clientY);C.sub(o.lastRawPoint).length<i||(e(c,H(s,o.startPoint,C)),o.lastRawPoint=C)},h=c=>{if(!c.isPrimary||!o.isWatchMove)return;const C=new u(c.clientX,c.clientY);n(c,H(s,o.startPoint,C)),o.isWatchMove=!1};return s.addEventListener("pointerdown",l),s.addEventListener("pointermove",a),s.addEventListener("pointerup",h),()=>{s.removeEventListener("pointerdown",l),s.removeEventListener("pointermove",a),s.removeEventListener("pointerup",h)}},yt=200,F=s=>{const[t,e]=s,n=new u((t.x+e.x)/2,(t.y+e.y)/2),i=t.sub(n).angle,o=e.sub(t).length;return{center:n,angle:i,dist:o}},St=s=>{const[t,e]=s;return{scroll:e.center.sub(t.center),angle:z(e.angle-t.angle),scale:e.dist/t.dist,center:e.center}},xt=(s,t,e,n,i=1)=>{let o=[],l,a=0,h=!1;const g=()=>{a=Date.now(),h=!1},c=()=>Date.now()-a<=yt,C=()=>{if(!(o.length<2))return[o[0].pagePoint,o[1].pagePoint]};s.ontouchstart=m=>{const y=m.changedTouches,w=o.length;for(let v=0;v<y.length;v++){const S=y[v];o.push({identifier:S.identifier,pagePoint:new u(S.pageX,S.pageY)})}w===0&&g(),w<=1&&o.length>=2&&c()&&(h=!0,l=C(),t())},s.ontouchend=m=>{const y=m.changedTouches;for(let w=0;w<y.length;w++)o=o.filter(v=>v.identifier!==y[w].identifier);o.length<=1&&h&&(h=!1,l=void 0,n())},s.ontouchmove=m=>{if(!h)return;let y=!1;for(let v=0;v<m.changedTouches.length;v++){const S=m.changedTouches[v],b=o.find(M=>M.identifier===S.identifier);if(b){const M=new u(S.pageX,S.pageY);b.pagePoint.sub(M).length>=i&&(b.pagePoint=M,y=!0)}}if(!y)return;const w=C();if(l&&w){const[v,S]=[F(l),F(w)],b=St([v,S]);e(b)}}},N=.2,$=4,Z=[0,N,.33,.5,.67,.75,1,1.5,2,2.5,3,3.5,$,1/0],j=(s,t)=>{var o;const e=t?Z:[...Z].reverse(),n=e.findIndex(l=>t?l>s:l<s),i=(o=e[n])!=null?o:0;return Math.max(N,Math.min($,i))},x=2,G=3;class kt{constructor(t,e,n){r(this,"width");r(this,"height");r(this,"canvas");r(this,"strokeCanvas");r(this,"view");r(this,"eventStatus",{isUseStrokeCanvas:!1,activeEvent:void 0,startCoord:new P,startPoint:new u,isCapturing:!1,isInMultiTouch:!1});r(this,"history");r(this,"requestChangeZoom",new f);r(this,"requestScrollTo",new f);r(this,"requestRotateTo",new f);r(this,"pen");r(this,"style",new K);r(this,"stamp");r(this,"_tool","draw");r(this,"_isKaleido",!1);r(this,"_backgroundColor","#ffffff");var o,l;this.width=e,this.height=n,this.canvas=new A(this.width*x,this.height*x),this.strokeCanvas=new A(this.width*x,this.height*x),this.view=new A(this.width*x,this.height*x),this.history=new ft(this.width*x,this.height*x),this.view.el.style.width=`${e}px`,this.view.el.style.height=`${n}px`,t.appendChild(this.view.el);const i=document.getElementById("debug");if(i){const a=200/Math.max(e,n);this.canvas.el.style.width=e*a+"px",this.canvas.el.style.height=n*a+"px",this.strokeCanvas.el.style.width=e*a+"px",this.strokeCanvas.el.style.height=n*a+"px",(o=i.querySelector(".canvas"))==null||o.appendChild(this.canvas.el),(l=i.querySelector(".stroke"))==null||l.appendChild(this.strokeCanvas.el)}xt(this.view.el,()=>{this.endStroke(!1),this.eventStatus.isInMultiTouch=!0},a=>this.onTouchTramsform(a),()=>{this.eventStatus.isInMultiTouch=!1},G),wt(this.view.el,a=>!this.eventStatus.isInMultiTouch&&this.onDown(a),(a,h)=>!this.eventStatus.isInMultiTouch&&this.onDrag(a,h),(a,h)=>!this.eventStatus.isInMultiTouch&&this.onUp(a,h),G),this.pen=new E,this.tool="draw",this.clear(!1)}get coord(){return this.canvas.coord}set coord(t){this.canvas.coord=t.clone({}),this.rePaint()}get tool(){return this._tool}set tool(t){this._tool=t,this.view.el.style.cursor=vt(t)}get isKaleido(){return this._isKaleido}set isKaleido(t){if(t===this._isKaleido)return;this._isKaleido=t;const e=this.penCount;this.penCount=1,this.penCount=e,this.rePaint()}get penCount(){return this.pen.childCount}set penCount(t){if(t===this.penCount)return;const e=this.pen;e.clearChildren();for(let n=0;n<t;n++){const i=this._isKaleido&&n%2!=0;e.addChildPen(new P({angle:n*360/t,flipY:i}))}this.rePaint()}set penWidth(t){this.style=this.style.clone({penSize:t})}set penColor(t){this.style=this.style.clone({color:t})}set penAlpha(t){this.style=this.style.clone({alpha:t})}get hasStamp(){return!!this.stamp}get backgroundColor(){return this._backgroundColor}set backgroundColor(t){this._backgroundColor!==t&&(this._backgroundColor=t,this.rePaint())}listenRequestZoom(...t){this.requestChangeZoom.listen(...t)}listenRequestScrollTo(...t){this.requestScrollTo.listen(...t)}listenRequestRotateTo(...t){this.requestRotateTo.listen(...t)}clear(t=!0){t&&(this.history.start(this.coord,this.pen.state,this.style,"clearAll"),this.history.commit(this.canvas)),k(this.canvas),this.rePaint()}undo(){!this.history.undoable||(this.clear(!1),this.history.undo(this.canvas,this.strokeCanvas),this.rePaint())}async toImgBlob(){return new Promise((t,e)=>{this.canvas.el.toBlob(n=>n?t(n):e())})}event2canvasPoint(t){return new u((t.offsetX-this.width/2)*x,(t.offsetY-this.height/2)*x)}onDown(t){const e=this.tool;if(this.eventStatus.activeEvent=e,this.eventStatus.startCoord=this.coord,this.eventStatus.startPoint=this.event2canvasPoint(t),this.eventStatus.isCapturing=t.metaKey,e==="zoomup"||e==="zoomdown"){const n=this.coord.scale;return e==="zoomup"&&this.requestChangeZoom.fire(j(n,!0)),e==="zoomdown"&&this.requestChangeZoom.fire(j(n,!1)),!1}return(e==="draw"||e==="draw:line"||e==="draw:stamp")&&this.startStroke(this.eventStatus.startPoint),!0}onDrag(t,e){const n=this.eventStatus.activeEvent;if(n==="draw"&&this.continueStroke(this.event2canvasPoint(t),t.pressure||.5),n==="draw:line"&&(k(this.strokeCanvas),this.pen.moveTo(this.eventStatus.startPoint),this.continueStroke(this.event2canvasPoint(t),t.pressure||.5)),n==="draw:stamp"&&this.stamp){k(this.strokeCanvas);const i=this.event2canvasPoint(t).sub(this.eventStatus.startPoint),o=i.length/100;this.putStroke(this.stamp,this.eventStatus.startPoint,o,i.angle,!0)}n==="scroll"&&this.onScroll(e),n==="rotate"&&this.onRotate(e),t.preventDefault()}onUp(t,e){var o,l;const n=this.eventStatus.activeEvent,i=n==="draw"||n==="draw:line"||n==="draw:stamp";if(n==="draw"&&this.continueStroke(this.event2canvasPoint(t),t.pressure||0),n==="draw:line"&&(k(this.strokeCanvas),this.pen.moveTo(this.eventStatus.startPoint),this.continueStroke(this.event2canvasPoint(t),this.history.current?ht(this.history.current.inputs):.5),(o=this.history.current)==null||o.clearPoints(!0,!0)),n==="draw:stamp"&&this.stamp){k(this.strokeCanvas);const a=this.event2canvasPoint(t).sub(this.eventStatus.startPoint),h=a.length/100;this.putStroke(this.stamp,this.eventStatus.startPoint,h,a.angle,!1)}if((n==="draw"||n==="draw:line")&&this.eventStatus.isCapturing){this.stamp=(l=this.history.current)==null?void 0:l.flatten,this.endStroke(!1),this.rePaint();return}n==="scroll"&&this.onScroll(e),n==="rotate"&&this.onRotate(e),this.endStroke(i)}startStroke(t){var e;this.eventStatus.isUseStrokeCanvas=!0,this.strokeCanvas.coord=this.canvas.coord,this.strokeCanvas.ctx.lineWidth=this.style.penSize*this.canvas.coord.scale,this.strokeCanvas.ctx.strokeStyle=this.eventStatus.isCapturing?"#0044aa":this.style.color,this.history.start(this.coord,this.pen.state,this.style),(e=this.history.current)==null||e.addPoint(t,.5),this.pen.moveTo(t)}continueStroke(t,e=.5){var n;(n=this.history.current)==null||n.addPoint(t,e),this.pen.drawTo(this.strokeCanvas,new DOMMatrix,t,e),this.rePaint()}endStroke(t){t?(this.history.commit(this.canvas),this.strokeCanvas.copy(this.canvas.ctx,{alpha:this.style.alpha}),k(this.strokeCanvas)):(this.history.rollback(),k(this.strokeCanvas)),this.eventStatus.isUseStrokeCanvas=!1,this.eventStatus.activeEvent=void 0}onScroll(t){const e=this.eventStatus.startCoord.scroll.move(t.distance.scale(-1/this.coord.scale*x).rotate(-this.coord.angle));this.requestScrollTo.fire(e)}onRotate(t){const e=this.eventStatus.startCoord.angle+t.angle;this.requestRotateTo.fire(z(e))}onTouchTramsform(t){const e=t.angle,n=t.scale,i=t.scroll.scale(-1/this.eventStatus.startCoord.scale**2/n*x).rotate(-this.eventStatus.startCoord.angle*2-e),o=ot(this.eventStatus.startCoord,new P({scroll:i,angle:e,scale:n}));this.requestChangeZoom.fire(o.scale),this.requestRotateTo.fire(o.angle),this.requestScrollTo.fire(o.scroll)}putStroke(t,e,n,i,o){const l=new E;l.state=this.pen.state;const a=new E;a.state=t.penState,a.coord=a.coord.clone({scroll:e,scale:n,angle:i}),l.leafs.forEach(c=>c.addChildPen()),l.leafs.forEach(c=>c.state=a.state);const h=new I(this.coord,l.state,this.style,t.tool);h.inputs.push(...t.inputs),X(this.strokeCanvas,h,o),this.rePaint();const g=this.history.current;!o&&g&&(this.history.rollback(),this.history.start(g.canvasCoord,l.state,this.style,g.tool).inputs.push(...t.inputs))}rePaint(){rt(this.view,"#cccccc"),this.canvas.output(this.view.ctx,{background:this.backgroundColor}),this.eventStatus.isUseStrokeCanvas&&this.strokeCanvas.output(this.view.ctx,{alpha:this.style.alpha}),this.penCount>=2&&lt(this.view,this.penCount,this.isKaleido)}}class O{constructor(t){r(this,"el");const e=this.el=document.createElement("button");e.className="Button",e.textContent=t}addEventListener(...t){return this.el.addEventListener(...t)}removeEventListener(...t){return this.el.removeEventListener(...t)}}class T{constructor(t,e=0,n=100,i=0,o=!1){r(this,"el");r(this,"elSlider");r(this,"elText");r(this,"isPercent");const l=this.el=document.createElement("div"),a=this.elSlider=document.createElement("input"),h=document.createElement("label"),g=document.createElement("span"),c=this.elText=document.createElement("span");this.isPercent=o,l.appendChild(h),h.appendChild(g),h.appendChild(c),h.appendChild(a),a.type="range",a.className="Slider",a.min=String(e),a.max=String(n),a.value=String(i),g.textContent=`${t}: `,c.textContent=a.value,a.addEventListener("input",()=>{c.textContent=a.value})}get value(){return this.elSlider.valueAsNumber*(this.isPercent?.01:1)}set value(t){const e=t*(this.isPercent?100:1);this.elSlider.value=String(e),this.elText.textContent=String(e)}addEventListener(...t){return this.elSlider.addEventListener(...t)}removeEventListener(...t){return this.elSlider.removeEventListener(...t)}}class V{constructor(t,e=!1){r(this,"el");r(this,"elCheck");const n=this.el=document.createElement("div"),i=this.elCheck=document.createElement("input"),o=document.createElement("label"),l=document.createElement("span");n.appendChild(o),o.appendChild(i),o.appendChild(l),n.className="Checkbox",i.type="checkbox",i.checked=e,l.textContent=t}get value(){return this.elCheck.checked}set value(t){this.elCheck.checked=t}addEventListener(...t){return this.elCheck.addEventListener(...t)}removeEventListener(...t){return this.elCheck.removeEventListener(...t)}}class J{constructor(t,e=!1){r(this,"el");r(this,"elColor");const n=this.el=document.createElement("div"),i=this.elColor=document.createElement("input"),o=document.createElement("label"),l=document.createElement("span");n.appendChild(o),o.appendChild(i),o.appendChild(l),n.className="ColorSelector",i.type="color",i.checked=e,l.textContent=t}get value(){return this.elColor.value}set value(t){this.elColor.value=t}addEventListener(...t){return this.elColor.addEventListener(...t)}removeEventListener(...t){return this.elColor.removeEventListener(...t)}}class Pt{constructor(t,e){r(this,"checks");r(this,"_value");r(this,"el");r(this,"_updating",!1);r(this,"onChange",new f);const n=Object.keys(t);this.checks=n.map(o=>({cb:new V(t[o]),key:o})),this.value=e,this._value=e,this.checks.forEach(o=>{o.cb.addEventListener("change",()=>{this._updating||o.cb.value&&(this.value=o.key)})});const i=this.el=document.createElement("div");i.className="RadioGroup",this.checks.forEach(o=>{i.appendChild(o.cb.el)})}get value(){return this._value}set value(t){const e=this._value!==t;this._value=t,this.updateChecked(),!!e&&this.onChange.fire(t)}updateChecked(){this._updating=!0,this.checks.forEach(t=>t.cb.value=t.key===this.value),this._updating=!1}listenChange(...t){this.onChange.listen(...t)}}const bt={draw:"Draw","draw:line":"Line","draw:stamp":"Stamp",scroll:"Move",rotate:"Rotate",zoomup:"+",zoomdown:"-"};class Et{constructor(t,e){r(this,"slScale");r(this,"slAngle");r(this,"slX");r(this,"slY");r(this,"slPenCount");r(this,"slPenWidth");r(this,"cbKaleido");r(this,"csDrawingColor");r(this,"csCanvasColor");r(this,"slDrawingAlpha");r(this,"cbTools");r(this,"onScaleChange",new f);r(this,"onAngleChange",new f);r(this,"onScrollChange",new f);r(this,"onPenCountChange",new f);r(this,"onPenWidthChange",new f);r(this,"onClear",new f);r(this,"onUndo",new f);r(this,"onCopy",new f);r(this,"onKaleidoChange",new f);r(this,"onDrawingColorChange",new f);r(this,"onCanvasColorChange",new f);r(this,"onDrawingAlphaChange",new f);r(this,"onToolChange",new f);r(this,"canvasWidth");r(this,"canvasHeight");this.canvasWidth=e.height,this.canvasHeight=e.height;const n=this.slScale=new T("Scale",50,300,100,!0),i=this.slAngle=new T("Angle",-360,360,0),o=this.slX=new T("Scroll X",-this.canvasWidth/2,this.canvasWidth/2,0),l=this.slY=new T("Scroll Y",-this.canvasHeight/2,this.canvasHeight/2,0),a=this.slPenCount=new T("Pen Count",1,32,1),h=this.slPenWidth=new T("Pen Size",2,100,20),g=new O("Clear All"),c=new O("Undo"),C=new O("Copy Image"),m=this.cbKaleido=new V("Kalaidoscope"),y=this.csDrawingColor=new J("Pen Color"),w=this.csCanvasColor=new J("BG Color"),v=this.slDrawingAlpha=new T("Pen Alpha",1,100,100,!0),S=this.cbTools=new Pt(bt,"draw");t.appendChild(S.el),t.appendChild(a.el),t.appendChild(m.el),t.appendChild(y.el),t.appendChild(w.el),t.appendChild(v.el),t.appendChild(h.el),t.appendChild(g.el),t.appendChild(c.el),t.appendChild(C.el),n.addEventListener("input",()=>{this.onScaleChange.fire(n.value)}),i.addEventListener("input",()=>{this.onAngleChange.fire(i.value)}),o.addEventListener("input",()=>{this.onScrollChange.fire(new u(o.value,l.value))}),l.addEventListener("input",()=>{this.onScrollChange.fire(new u(o.value,l.value))}),a.addEventListener("input",()=>{this.onPenCountChange.fire(a.value)}),h.addEventListener("input",()=>{this.onPenWidthChange.fire(h.value)}),g.addEventListener("click",()=>{this.onClear.fire()}),c.addEventListener("click",()=>{this.onUndo.fire()}),C.addEventListener("click",()=>{this.onCopy.fire()}),m.addEventListener("change",()=>{this.onKaleidoChange.fire(m.value),this.updateKareido2PenCount()}),y.addEventListener("input",()=>{this.onDrawingColorChange.fire(y.value)}),w.addEventListener("input",()=>{this.onCanvasColorChange.fire(w.value)}),v.addEventListener("input",()=>{this.onDrawingAlphaChange.fire(v.value)}),S.listenChange(b=>this.onToolChange.fire(b))}get scale(){return this.slScale.value}get angle(){return this.slAngle.value}get scroll(){return new u(this.slX.value,this.slY.value)}get penCount(){return this.slPenCount.value}get penWidth(){return this.slPenWidth.value}get kaleidoscope(){return this.cbKaleido.value}get drawingColor(){return this.csDrawingColor.value}get canvasColor(){return this.csCanvasColor.value}get drawingAlpha(){return this.slDrawingAlpha.value}get tool(){return this.cbTools.value}set scale(t){this.scale!==t&&(this.slScale.value=t,this.onScaleChange.fire(this.slScale.value),this.updateScrollRange())}set angle(t){this.angle!==t&&(this.slAngle.value=t,this.onAngleChange.fire(this.slAngle.value))}set scrollX(t){this.slX.value!==t&&(this.slX.value=t,this.onScrollChange.fire(new u(this.slX.value,this.slY.value)))}set scrollY(t){this.slY.value!==t&&(this.slY.value=t,this.onScrollChange.fire(new u(this.slX.value,this.slY.value)))}set penCount(t){this.penCount!==t&&(this.slPenCount.value=t,this.onPenCountChange.fire(this.slPenCount.value))}set penWidth(t){this.penWidth!==t&&(this.slPenWidth.value=t,this.onPenWidthChange.fire(this.slPenWidth.value))}set kaleidoscope(t){this.kaleidoscope!==t&&(this.cbKaleido.value=t,this.onKaleidoChange.fire(this.cbKaleido.value),this.updateKareido2PenCount())}set drawingColor(t){this.drawingColor!==t&&(this.csDrawingColor.value=t,this.onDrawingColorChange.fire(this.csDrawingColor.value))}set canvasColor(t){this.canvasColor!==t&&(this.csCanvasColor.value=t,this.onCanvasColorChange.fire(this.csCanvasColor.value))}set drawingAlpa(t){this.drawingAlpa!==t&&(this.slDrawingAlpha.value=t,this.onDrawingAlphaChange.fire(this.slDrawingAlpha.value))}set tool(t){this.cbTools.value=t}penCountUp(){this.penCount+=this.kaleidoscope?2:1}penCountDown(){this.penCount-=this.kaleidoscope?2:1}updateKareido2PenCount(){const t=this.cbKaleido.value;t&&(this.penCount+=this.penCount%2),this.slPenCount.elSlider.min=t?"2":"1",this.slPenCount.elSlider.step=t?"2":"1"}updateScrollRange(){const t=this.canvasWidth/2*this.scale,e=this.canvasHeight/2*this.scale;this.slX.elSlider.min=String(-t),this.slX.elSlider.max=String(t),this.slY.elSlider.min=String(-e),this.slY.elSlider.max=String(e)}}class Tt{constructor(t){r(this,"target");r(this,"_keys",{});r(this,"_removeEvents");r(this,"onChange",new f);this.target=t!=null?t:document.body;const e=i=>{const o=i.key;this._keys[o]=!0,this.onChange.fire({key:o,isDown:!0})},n=i=>{const o=i.key;delete this._keys[o],this.onChange.fire({key:o,isDown:!1})};this.target.addEventListener("keydown",e),this.target.addEventListener("keyup",n),this._removeEvents=()=>{this.target.removeEventListener("keydown",e),this.target.removeEventListener("keyup",n)}}listen(...t){this.onChange.listen(...t)}destroy(){this._removeEvents(),this.onChange.clear()}key(t){return!!this._keys[t]}get keys(){return Object.keys(this._keys)}}const Lt=s=>{const t=s.includes(" "),e=s.includes("Alt"),n=s.includes("Meta"),i=s.includes("Shift");return t&&n&&e?"zoomdown":t&&n?"zoomup":t&&e?"rotate":t?"scroll":i?"draw:line":e?"draw:stamp":"draw"};class Mt{constructor(){r(this,"keyWatcher");r(this,"tool");r(this,"onChange",new f);this.keyWatcher=new Tt,this.keyWatcher.listen(()=>{const t=Lt(this.keyWatcher.keys);this.tool!==t&&(this.tool=t,this.onChange.fire(t))})}listenChange(...t){this.onChange.listen(...t)}}const W=document.querySelector("#main"),At=document.querySelector("#palette"),q=document.querySelector("#toast"),_=new u(W.offsetWidth,W.offsetHeight),It=s=>{q.textContent=s,q.classList.add("visible"),setTimeout(()=>{q.classList.remove("visible")},5e3)},p=new Et(At,{width:_.x,height:_.y}),d=new kt(W,_.x,_.y);p.onScaleChange.listen(s=>{d.coord=d.coord.clone({scale:s})});p.onAngleChange.listen(s=>{d.coord=d.coord.clone({angle:s})});p.onScrollChange.listen(s=>{d.coord=d.coord.clone({scroll:s})});p.onPenCountChange.listen(s=>{d.penCount=s});p.onPenWidthChange.listen(s=>{d.penWidth=s});p.onClear.listen(()=>{d.clear()});p.onUndo.listen(()=>{d.undo()});p.onCopy.listen(async()=>{const s=await d.toImgBlob(),t=new ClipboardItem({"image/png":s});await navigator.clipboard.write([t])});p.onKaleidoChange.listen(s=>{d.isKaleido=s});p.onDrawingColorChange.listen(s=>{d.penColor=s});p.onCanvasColorChange.listen(s=>{d.backgroundColor=s});p.onDrawingAlphaChange.listen(s=>{d.penAlpha=s});p.onToolChange.listen(s=>{if(d.tool=s,s==="draw:stamp"&&!d.hasStamp){const t={ja:"\u30B9\u30BF\u30F3\u30D7\u3092\u4F7F\u7528\u3059\u308B\u306B\u306F\u3001\u5148\u306BCommand(Ctrl)\u3092\u62BC\u3057\u306A\u304C\u3089\u7DDA\u3092\u5F15\u3044\u3066\u30B9\u30BF\u30F3\u30D7\u3092\u8A18\u9332\u3057\u307E\u3059",en:"Before using stamp, draw with Command(Ctrl) key for record a stroke."}[Q];It(t)}});d.coord=d.coord.clone({scroll:p.scroll,scale:p.scale,angle:p.angle});d.listenRequestZoom(s=>{d.coord=d.coord.clone({scale:s})});d.listenRequestScrollTo(s=>{d.coord=d.coord.clone({scroll:s})});d.listenRequestRotateTo(s=>{d.coord=d.coord.clone({angle:s})});window.addEventListener("keydown",s=>{s.key==="ArrowUp"&&p.penCountUp(),s.key==="ArrowDown"&&p.penCountDown(),s.key==="z"&&s.metaKey&&p.onUndo.fire(),s.key==="z"&&s.metaKey&&p.onCopy.fire()});const Dt=new Mt;Dt.listenChange(s=>p.tool=s);p.kaleidoscope=!0;p.penCount=6;p.canvasColor="#ffffff";W.addEventListener("touchmove",function(s){s.preventDefault()});const Q=navigator.language==="ja"?"ja":"en";document.querySelectorAll(".lang").forEach(s=>s.style.display="none");document.querySelectorAll(`.lang.${Q}`).forEach(s=>s.style.display="");
